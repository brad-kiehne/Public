#Log Function
Function Log-Message()
{
 param
    (
    [Parameter(Mandatory=$true)] [string] $Message
    )
 
    Try {
        #Get the current date
        $LogDate = (Get-Date).tostring("ddMMyyyy")
 
        #Get the Location of the script
        If ($psise) {
            $CurrentDir = Split-Path $psise.CurrentFile.FullPath
        }
        Else {
            $CurrentDir = $Global:PSScriptRoot
        }
 
        #Frame Log File with Current Directory and date
        $LogFile = $CurrentDir+ "\" + $LogDate + ".txt"
 
        #Add Content to the Log File
        $TimeStamp = (Get-Date).toString("dd/MM/yyyy HH:mm:ss:fff tt")
        $Line = "$TimeStamp - $Message"
        Add-content -Path $Logfile -Value $Line
 
        Write-host "Message: '$Message' Has been Logged to File: $LogFile"
    }
    Catch {
        Write-host -f Red "Error:" $_.Exception.Message 
    }
}
#GitHub URLs
$PowerPlan = "https://raw.githubusercontent.com/brad-kiehne/Public/main/HighPerformance_Power"
$Apps = "https://raw.githubusercontent.com/brad-kiehne/Public/main/Remove_Win10_Apps"
$Unpin = "https://raw.githubusercontent.com/brad-kiehne/Public/main/Unpin_Win10_StartMenu"
$Defaults = "https://raw.githubusercontent.com/brad-kiehne/Public/main/MoeBuilderV8.2BASE"
$Wallpaper = "https://raw.githubusercontent.com/brad-kiehne/Public/main/Wallpaper"
$Win11Defaults = "https://raw.githubusercontent.com/brad-kiehne/Public/main/Win11_Startmenu"
$OEMFix = "https://raw.githubusercontent.com/brad-kiehne/Public/main/Dell_Optimizer_Uninstall"

#Build Folder Structure
Log-Message "Building Moetech Folder Structure"
$rootpath = "C:\Moetech"
If(!(test-path -PathType container $rootpath))
{
      New-Item -ItemType Directory -Path $rootpath
}

$Logpath = "C:\Moetech\Logs"
If(!(test-path -PathType container $Logpath))
{
      New-Item -ItemType Directory -Path $Logpath
}

$Softwarepath = "C:\Moetech\Software"
If(!(test-path -PathType container $Softwarepath))
{
      New-Item -ItemType Directory -Path $Softwarepath
}

$ODTpath = "C:\Moetech\ODT"
If(!(test-path -PathType container $ODTpath))
{
      New-Item -ItemType Directory -Path $ODTpath
}

$3PPpath = "C:\Moetech\Software\3PP"
If(!(test-path -PathType container $3PPpath))
{
      New-Item -ItemType Directory -Path $3PPpath
}


#Step one - Deploy High-Performance Power Plan
Log-Message "Loading Step One: High-Performance Power Plan Configuration"
$ScriptFromGitHub = Invoke-WebRequest $PowerPlan -UseBasicParsing
Invoke-Expression $($ScriptFromGitHub.Content)

#Step two - Nix Windows 10 Bloatware
Log-Message "Loading Step Two: Windows 10 Third Party App Removal"
$ScriptFromGitHub = Invoke-WebRequest $Apps -UseBasicParsing
Invoke-Expression $($ScriptFromGitHub.Content)

#Step Three - Unpin Windows 10 Menus
Log-Message "Loading Step Three: Unpinning Windows 10/11 Start Menu Items"
$ScriptFromGitHub = Invoke-WebRequest $Unpin -UseBasicParsing
Invoke-Expression $($ScriptFromGitHub.Content)

#Step Four - Nix Windows 11 Bloatware (Includes installation for Office365, Chrome, Teams, Adobe, VLC and PMPC)
Log-Message "Loading Step 4 Removing Windows 11 Third-Party Apps and Updating Office365, Chrome, Teams, Adobe, VLC and PMPC"
$ScriptFromGitHub = Invoke-WebRequest $Defaults -UseBasicParsing
Invoke-Expression $($ScriptFromGitHub.Content)

#Step Five - Deploy ADITS External Wallpaper
Log-Message "Loading Step Five: Pushing ADITS External Desktop Background"
$ScriptFromGitHub = Invoke-WebRequest $Wallpaper -UseBasicParsing
Invoke-Expression $($ScriptFromGitHub.Content)

#Step Six - Window 11 Specific Defaults
Log-Message "Loading Step Six: Pushing Windows 11 Specific Defaults"
$ScriptFromGitHub = Invoke-WebRequest $Win11Defaults -UseBasicParsing
Invoke-Expression $($ScriptFromGitHub.Content)

#Step Seven - OEM Specific Fix
Log-Message "Loading Step Seven: DELL OEM Fixes applied"
$ScriptFromGitHub = Invoke-WebRequest $OEMFix -UseBasicParsing
Invoke-Expression $($ScriptFromGitHub.Content)

#Unload - Close Session, handback to CWA
Log-Message "Loader Completed all steps, Handing back to CWA Script Engine"